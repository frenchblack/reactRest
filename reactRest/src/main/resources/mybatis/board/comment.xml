<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spring.react.mapper.board.CommentMapper">
	<select id="getCommentList" resultType="com.spring.react.vo.comment.CommentVO"> 
		SELECT A.COMMENT_NO AS COMMENT_NO
		     , A.BOARD_NO AS BOARD_NO
		     , A.USER_ID AS USER_ID
		     , B.USER_NM AS USER_NM
		     , A.WRITE_DATE AS WRITE_DATE
		     , CASE
		           WHEN A.EX_DEL = 1 THEN '삭제된 댓글입니다.'
		           ELSE A.COMMENT_CONTENT
		       END AS COMMENT_CONTENT
		     , A.EX_DEL AS EX_DEL
		     , A.LIKE_CNT AS LIKE_CNT
		     , A.COMMENT_LVL AS COMMENT_LVL
		     , A.P_COMMENT_NO AS P_COMMENT_NO
		     , ( SELECT COUNT(1)
		           FROM COMMENT C
		          WHERE C.P_COMMENT_NO = A.COMMENT_NO
		            AND C.COMMENT_LVL = 1
		            AND C.EX_DEL = 0
		       ) AS C_COMMENT_CNT
		     , CASE
		           WHEN #{viewer_user_id} IS NULL THEN 0
		           WHEN EXISTS (
		                SELECT 1
		                  FROM COMMENT_LIKE D
		                 WHERE D.COMMENT_NO = A.COMMENT_NO
		                   AND D.USER_ID = #{viewer_user_id}
		                   AND D.REACTION_CD = 1
		           ) THEN 1
		           ELSE 0
		       END AS MY_LIKE_YN
		     , CASE
		           WHEN #{viewer_user_id} IS NULL THEN 0
		           WHEN A.USER_ID = #{viewer_user_id} THEN 1
		           ELSE 0
		       END AS OWNER_YN
		  FROM COMMENT A
		 INNER JOIN USERS B
		    ON A.USER_ID = B.USER_ID
		 WHERE A.BOARD_NO = #{board_no}
		   AND A.COMMENT_LVL = 0
		 ORDER BY A.WRITE_DATE
		        , A.COMMENT_NO
		 LIMIT #{size}
		 OFFSET #{offset}
	</select>
	<insert id="insertComment" parameterType="com.spring.react.vo.comment.CommentVO" useGeneratedKeys="true" keyProperty="comment_no">
		INSERT INTO COMMENT (
		         BOARD_NO
		       , USER_ID
		       , COMMENT_CONTENT
		       , WRITE_DATE
		       , EX_DEL
		       , LIKE_CNT
		       , COMMENT_LVL
		  )
		  VALUES (
		         #{board_no}
		       , #{user_id}
		       , #{comment_content}
		       , NOW()
		       , 0
		       , 0
		       , 0
		  )
		  <selectKey keyProperty="comment_no" resultType="int" order="AFTER">
		    SELECT LAST_INSERT_ID()
		  </selectKey>
	</insert>
	
	<update id="updateCommentContent">
	  UPDATE COMMENT A
	     SET A.COMMENT_CONTENT = #{comment_content}
	   WHERE A.COMMENT_NO = #{comment_no}
	     AND A.USER_ID    = #{user_id}
	     AND A.EX_DEL     = 0
	</update>
	
	<update id="deleteComment">
	  UPDATE COMMENT A
	     SET A.EX_DEL = 1
	   WHERE A.COMMENT_NO = #{comment_no}
	     AND A.USER_ID    = #{user_id}
	     AND A.EX_DEL     = 0
	</update>
	
	<select id="getCommentTotalCnt" resultType="int">
		SELECT COUNT(1) AS TOTAL_CNT
		  FROM COMMENT A
		 WHERE A.BOARD_NO = #{board_no}
		   AND A.COMMENT_LVL = 0
	</select>
	<select id="getWriter" resultType="int">
		SELECT COUNT(1) AS WRITER
		  FROM COMMENT A
		 WHERE A.COMMENT_NO = #{comment_no}
		   AND A.USER_ID    = #{user_id}
	</select>	
	<select id="getReactionCd" resultType="int">
	  SELECT A.REACTION_CD AS REACTION_CD
	    FROM COMMENT_LIKE A
	   WHERE A.COMMENT_NO = #{comment_no}
	     AND A.USER_ID    = #{user_id}
	</select>
	
	<insert id="upsertReaction">
	  INSERT INTO COMMENT_LIKE (
	        COMMENT_NO
	      , USER_ID
	      , REACTION_CD
	  ) VALUES (
	        #{comment_no}
	      , #{user_id}
	      , #{reaction_cd}
	  )
	  ON DUPLICATE KEY UPDATE
	        REACTION_CD = #{reaction_cd}
	</insert>
	
	<delete id="deleteReaction">
	  DELETE
	    FROM COMMENT_LIKE A
	   WHERE A.COMMENT_NO = #{comment_no}
	     AND A.USER_ID    = #{user_id}
	</delete>
	
	<update id="updateLikeCnt">
	  UPDATE COMMENT A
	     SET A.LIKE_CNT = A.LIKE_CNT + #{delta}
	   WHERE A.COMMENT_NO = #{comment_no}
	</update>
	
	<select id="getLikeCnt" resultType="int">
	  SELECT A.LIKE_CNT AS LIKE_CNT
	    FROM COMMENT A
	   WHERE A.COMMENT_NO = #{comment_no}
	</select>
</mapper>
